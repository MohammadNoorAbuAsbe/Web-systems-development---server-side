<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>My Movies</title>
    <link href="styles/style.css" rel="stylesheet" />
    <script src="scripts/ajaxCalls.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>
    <script src="scripts/shared.js"></script>
    <script>
        $(document).ready(function () {
            initializePage();
        });

        function initializePage() {
            retriveFromServer();
            setupFilterHandlers();
        }

        function setupFilterHandlers() {
            const filterTitleInput = $('#filterTitle');
            const filterTitleBtn = $('#filterTitleBtn');
            const startDateInput = $('#startDate');
            const endDateInput = $('#endDate');
            const filterDateBtn = $('#filterDateBtn');

            filterTitleBtn.prop('disabled', true);
            filterDateBtn.prop('disabled', true);

            filterTitleInput.on('input', function () {
                filterTitleBtn.prop('disabled', $(this).val().trim() === '');
            });

            startDateInput.add(endDateInput).on('input', function () {
                filterDateBtn.prop('disabled', startDateInput.val() === '' || endDateInput.val() === '');
            });

            filterTitleBtn.click(() => filterMoviesByTitle(filterTitleInput.val()));
            filterDateBtn.click(() => filterMoviesByDate(startDateInput.val(), endDateInput.val()));
            $('#clearFilterBtn').click(clearFilter);
        }

        function renderMovies(movies) {
            const moviesContainer = $('#moviesContainer');
            moviesContainer.empty();

            if (movies.length === 0) {
                showNotification('No movies found.', 'info');
                return;
            }

            renderMovieCards('Delete', deleteMovie, moviesContainer, movies);
        }

        function setActiveFilter(filterText) {
            const activeFilter = $('#activeFilter');
            activeFilter.html(`
                    <span>${filterText}</span>
                    <button id="clearFilterBtn">X</button>
                `).show();

            $('#clearFilterBtn').click(clearFilter);
        }

        function clearActiveFilter() {
            const activeFilter = $('#activeFilter');
            activeFilter.hide().empty();
        }

        function clearFilter() {
            $('#filterTitle').val('').trigger('input');
            $('#startDate').val('').trigger('input');
            $('#endDate').val('').trigger('input');
            retriveFromServer();
        }

        function retriveFromServer() {
            clearActiveFilter();
            ajaxCall('GET', urlGetCart, "", renderMovies, handleError);
        }

        function deleteMovie(movieId) {
            ajaxCall('DELETE', `${urlDelete}/${movieId}`, "", (response) => {
                handleSuccess(
                    response,
                    '🎉 Success! The movie has been deleted from your list.',
                    'ℹ️ No changes were made. The movie might already be deleted.'
                );
                retriveFromServer();
            }, handleError);
        }

        function filterMoviesByTitle(title) {
            ajaxCall('GET', `${urlFilterByTitle}?title=${title}`, "", function (movies) {
                renderMovies(movies);
                setActiveFilter(`🔍 Filter applied: Movies with the title "${title}".`);
            }, handleError);
        }

        function filterMoviesByDate(startDate, endDate) {
            ajaxCall('GET', `${urlFilterByDate}?startDate=${startDate}&endDate=${endDate}`, "", function (movies) {
                renderMovies(movies);
                setActiveFilter(`📅 Filter applied: Movies released between ${startDate} and ${endDate}.`);
            }, handleError);
        }
    </script>
</head>
<body>
    <header>
        <nav>
            <a href="index.html">Home</a>
            <a href="MyMovies.html">My Movies</a>
        </nav>
    </header>
    <div class="container">
        <div id="notification" class="notification"></div>
        <div class="filters">
            <input type="text" id="filterTitle" placeholder="Filter by Title" />
            <button id="filterTitleBtn">Filter</button>
            <input type="date" id="startDate" placeholder="Start Date" />
            <input type="date" id="endDate" placeholder="End Date" />
            <button id="filterDateBtn">Filter</button>
        </div>
        <div id="activeFilter" class="active-filter" style="display: none;"></div>
        <h1 id="title">My Movies</h1>
        <div id="moviesContainer"></div>
    </div>
</body>
</html>
